# Deploying HelpCovid 
## NOTE: This document is still work in progress


### Steps
1. Spin up a virtual machine running Debian
2. Create a `helpcovid`` user and group
3. Create SSL certificate (optional)
4. Adjust Firewall settings
5. Install PostgreSQL
6. Clone and build `helpcovid`
7. Generate configuration file
8. Run `helpcovid`




## 3. Creating a self-signed certificate

Although running HelpCovid as an HTTPS service is option, it is highly
recommended. If it is to be run as an HTTPS service, HelpCovid requires that an 
SSL certificate and its corresponding private key be available. Typically, such
certificates and private keys are obtained from a registered Certificate
Authority (CA).

However, in case an SSL certificate from a Certificate Authority is not
available, there is always the option of creating a self-signed certificate.
However, it is important to note that although HelpCovid will be able to run as
an HTTPS service using self-signed certificates, users running HelpCovid in
their web browser will receive a warning message.

On Debian, there are two ways to create a self-signed certificate. The first
option is more involved, but gives greater control on the generation of the
certificate. In contrast, the latter option is simpler, but gives less control
over the generation of the certificate. We will discuss both options.

### 3.1 Using the `openssl` package

```
sudo apt install openssl
sudo mkdir -p /etc/ssl/localcerts
sudo openssl req -new -x509 -days 365 -nodes \
 -out /etc/ssl/localcerts/helpcovid.pem  \
 -keyout /etc/ssl/localcerts/helpcovid.key
sudo chmod 600 /etc/ssl/localcerts/helpcovid*
```

A series of questions will be asked, which would need to be answered. An
illustrative set of answers is shown below.

```
Output
Country Name (2 letter code) [AU]:FR
State or Province Name (full name) [Some-State]:Paris
Locality Name (eg, city) []:Bourg Le Reine
Organization Name (eg, company) [Internet Widgits Pty Ltd]:HelpCovid
Organizational Unit Name (eg, section) []:HelpCovid
Common Name (e.g. server FQDN or YOUR name) []:your_domain_or_server_IP_address
Email Address []:admin@your_domain.com
```

The most important questions that need to be answered are the last two, so
please be sure to provide appropriate answers.

### 3.2 Using the `ssl-cert` package

```
sudo apt install openssl
sudo apt install ssl-cert
```

The certificate is stored at `/etc/ssl/certs/ssl-cert-snakeoil.pem` and the
private key at `/etc/ssl/private/ssl-cert-snakeoil.key`.

At any time, the certificate and key may be regenerated by running the following
command: `sudo make-ssl-cert generate-default-snakeoil --force-overwrite`


### Using Let's Encrypt
```
sudo git clone https://github.com/letsencrypt/letsencrypt /opt/letsencrypt
cd /opt/letsencrypt
sudo -H ./letsencrypt-auto certonly --standalone -d example.com -d www.example.com
```

When prompted, specify an administrative email address. This will allow you to 
regain control of a lost certificate and receive urgent security notices if 
necessary. Press ENTER or RETURN to save.

Agree to the Terms of Service and specify if you would like to share your email 
address with EFF:

/etc/letsencrypt/live/example.com/fullchain.pem
/etc/letsencrypt/live/example.com/privkey.pem

** don't use the other *.pem files **

auto renew certificates

cd /opt/letsencrypt
./letsencrypt-auto renew
sudo crontab -e
```

Add the following to the end of the crontab file:
`0 0 1 * * /opt/letsencrypt/letsencrypt-auto renew`

## 4. Adjust Firewall Settings

```
sudo apt install ufw
sudo ufw allow OpenSSH
```

`sudo ufw allow 8089/tcp` for custom port
or
`sudo ufw allow https` for HTTPS

```
sudo ufw enable
sudo ufw status
```


## Installing PostgreSQL

```
sudo apt install postgresql postgresql-client
sudo pg_isready 
sudo systemctl status postgresql
```

### Securing PostgreSQL
```
sudo passwd postgres
sudo vim /etc/postgresql/11/main/pg_hba.conf
```
Change "trust" to "md5"


## Cloning and building HelpCovid

```
sudo apt install build-essential
sudo apt install g++
sudo apt install git
sudo apt install libjsoncpp-dev
cd ~/helpcovidu
git clone https://github.com/bstarynk/helpcovid.git
make
```

